{% extends 'shop/base.html' %}

{% block header %}
<style>

/* .container {
  background-color: #f2f2f2;
  padding: 5px 20px 15px 20px;
  border: 1px solid lightgrey;
  border-radius: 3px;
} */

input[type=text] {
  width: 100%;
  margin-bottom: 20px;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 3px;
}

label {
  margin-bottom: 10px;
  display: block;
}

.icon-container {
  margin-bottom: 20px;
  padding: 7px 0;
  font-size: 24px;
}


span.price {
  float: right;
  color: grey;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{% endblock %}

{% block content %}
{% load humanize %}
{% load humanize %}

<div class="container">
  <div class='row'>
      <div class="col-12 ml-auto mr-auto">
          <h2 class="index-title-index text-center">CHECKOUT(결제)</h2>
          <hr class="index-title-divider">
      </div>
  </div>
</div>  

<div class='container'>
    <!-- 마지막 체크아웃 부트스트랩 버전-->
    <div class="row">
        {% if not shipping_address_obj %}
        <div class="col-lg-7 col-md-6 col-sm-12 mb-5">
            <div class="container">
                <form method='post' action="{% url 'carts:checkout-iamport' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class='col-12 pl-0 pr-3 text-left'>
                            <p class='mb-1' style='font-weight:bold;font-size:large;'>배송지 정보</p>
                            <hr class='mt-0' style='border-top:2px solid #423f3b;height:5px;box-shadow: 0 10px 5px -10px #8c8c8c inset;'>
                        </div>
                        <div class='row' style='width:100%'>
                            <div class='col-6'>
                                <label for="fname"><i class="fa fa-user"></i> 수령인</label>
                                <!-- <input type="text" id="fname" name="full-name" placeholder="홍길동">   -->
                                <p>{{ user.full_name }}</p>
                            </div>
                            <div class='col-6'>
                                <label for="email"><i class="fa fa-envelope"></i> Email</label>
                                <!-- <input type="text" id="email" name="email" placeholder="john@example.com"> -->
                                <p>{{ user.email }}</p>
                            </div>
                        </div>
                        <div class='row' style='width:100%'>
                            <div class='col-12'>
                                <label for="phone_number"><i class="fas fa-mobile-alt"></i> 연락처(- 기호 제외하여 입력)</label>
                                <input type="text" id="phone_number" name="phone_number" placeholder="01012345678">
                                
                                <label for="address_line_1"><i class="fa fa-institution"></i> 주소</label>
                                <input type="text" id="city" name="address_line_1" placeholder="">
                                <label for="postal_code"><i class="fa fa-institution"></i> 우편번호</label>
                                <input type="text" id="postal_code" name="postal_code" placeholder="">
                                <label for="address_line_2"><i class="fa fa-address-card-o"></i> 상세주소</label>
                                <input type="text" id="adr" name="address_line_2" placeholder="">
                                <label for="order_memo"><i class="far fa-sticky-note"></i> 배송메모</label>
                                <input type="text" id="memo" name="order_memo" placeholder="요청사항을 직접 입력합니다.">
                                <input type="hidden" name='post_purpose' value='change_or_add_address'>
                            </div>
                        </div>
                        <div class='col-12'>
                            <button class='btn btn-dark btn-block' method='post' action="{% url 'carts:checkout-iamport' %}">배송지 정보 저장</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <div class="col-lg-7 col-md-6 col-sm-12 mb-5">
            <div class="container">
                <form method='post' action="{% url 'carts:checkout-iamport' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class='col-12 pl-0 pr-3 text-left'>
                            <p class='mb-1' style='font-weight:bold;font-size:large;'>배송지 정보</p>
                            <hr class='mt-0' style='border-top:2px solid #423f3b;height:5px;box-shadow: 0 10px 5px -10px #8c8c8c inset;'>
                        </div>
                        <div class='row' style='width:100%'>
                            <div class='col-6'>
                                <label for="fname"><i class="fa fa-user"></i> 수령인</label>
                                <!-- <input type="text" id="fname" name="full-name" placeholder="홍길동">   -->
                                <p>{{ user.full_name }}</p>
                            </div>
                            <div class='col-6'>
                                <label for="email"><i class="fa fa-envelope"></i> Email</label>
                                <!-- <input type="text" id="email" name="email" placeholder="john@example.com"> -->
                                <p>{{ user.email }}</p>
                            </div>
                        </div>
                        <div class='row' style='width:100%'>
                            <div class='col-12'>
                                <label for="phone"><i class="fas fa-mobile-alt"></i> 연락처(- 기호 제외하여 입력)</label>
                                <input type="text" id="phone_number" name="phone_number" placeholder="{{ shipping_address_obj.phone_number }}">
                                <label for="address_line_1"><i class="fa fa-institution"></i> 주소</label>
                                <input type="text" id="city" name="address_line_1" placeholder="{{ shipping_address_obj.address_line_1 }}">
                                <label for="address_line_2"><i class="fa fa-address-card-o"></i> 상세주소</label>
                                <input type="text" id="adr" name="address_line_2" placeholder="{{ shipping_address_obj.address_line_2 }}">
                                <label for="order_memo"><i class="far fa-sticky-note"></i> 배송메모</label>
                                <input type="text" id="memo" name="order_memo" placeholder="요청사항을 직접 입력합니다.">
                                <input type="hidden" name='post_purpose' value='change_or_add_address'>
                            </div>
                        </div>
                    </div>
                    <div class='col-12'>
                        <button class='btn btn-dark btn-block' method='post' action="{% url 'carts:checkout-iamport' %}">배송지 정보 수정 저장</button>
                    </div>
                    <!-- <label>
                        <input type="checkbox" checked="checked" name="sameadr"> Shipping address same as billing
                    </label>
                    <input type="submit" value="Continue to checkout" class="btn"> -->
                </form>
            </div>
        </div>

        {% endif %}
        <div class="col-lg-5 col-md-6 col-sm-12">
            <div class="container mb-5">
                <div class="row" style='width:100%'>
                    <div class='col-12 pl-0 pr-3 text-left'>
                        <p class='mb-1' style='font-weight:bold;font-size:large;'>장바구니</p>
                        <hr class='mt-0' style='border-top:2px solid #423f3b;height:5px;box-shadow: 0 10px 5px -10px #8c8c8c inset;'>
                    </div>
                    {% for cart_item in object.cart.cart_items.all %}
                    <div class='row' style='width:100%'>
                        <div class='col-6'>
                            {% if cart_item.product_type == 'ticket' %}
                            <p class='mb-1' style='font-size:medium;'>TICKET {{ cart_item.ticket_item.tickets_type }}개</p>
                            {% elif cart_item.product_type == 'bidding' or cart_item.product_type == 'normal' %}
                            <p class='mb-1' style='font-size:medium;'>{{ cart_item.product_item.product.title }}</p>
                            {% else %}
                            <p class='mb-1' style='font-size:medium;font-weight:bold;'>물품명잘못지정됨</p>
                            {% endif %}
                        </div>
                        <div class='col-6 text-right'>
                            <p style='font-size:smediummall;'>{{ cart_item.subtotal|intcomma }} 원</p>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="col-12 m-0 p-0">
                        <hr class='mt-0' style='border-top:2px dotted #423f3b;'>
                    </div>
                    <div class='row' style='width:100%'>
                        <div class='col-6'>
                            <p style='font-size:medium;'>주문 금액</p>
                        </div>
                        <div class='col-6 text-right'>
                            <p style='font-size:medium;'>{{ object.total|intcomma }} 원</p>
                        </div>
                    </div>
                    <div class='row' style='width:100%'>
                        <div class='col-6'>
                            <p style='font-size:medium;'>포인트 사용</p>
                        </div>
                        <div class='col-6 text-right'>
                            <p style='font-size:medium;'>{% if object.point_total == 0 %}0 원{% else %}-{{ object.point_total|intcomma }} 원{% endif %}</p>
                        </div>
                    </div>
                    <div class="col-12 m-0 p-0">
                        <hr class='mt-0' style='border-top:2px dotted #423f3b;'>
                    </div>
                    <div class='row' style='width:100%'>
                        <div class='col-6'>
                            <p style='font-size:large;font-weight:bold;'>결제 금액</p>
                        </div>
                        <div class='col-6 text-right'>
                            <p style='font-size:large;font-weight:bold;'>{{ object.checkout_total|intcomma }} 원</p>
                        </div>
                    </div>
                    <div class='col-12 p-0'>
                        <hr class='mt-0' style='border-top:2px solid #423f3b;height:5px;box-shadow: 0 10px 5px -10px #8c8c8c inset;'>
                    </div>
                    <div class="row" style='width:100%;'>
                        <div class='col-12'>
                            {% if not shipping_address_obj %}
                            <button class='btn btn-outline-secondary btn-block'>배송지 정보를 완료해주세요</button>
                            {% elif amount == 0 %}
                            <form method='post' action="{% url 'carts:checkout-iamport' %}">
                                {% csrf_token %}
                                <input type="hidden" name='post_purpose' value='checkout_0'>
                                <button type='submit' class='btn btn-dark btn-block'>결제하기</button>
                            </form>
                            {% else %}
                            <div class='check-out-div' style='visibility:hidden;'>
                                <input type='button' class='btn btn-dark btn-block' id='check-out-button' value='결제하기'>
                            </div>
                            {% endif %}
                        </div>
                    </div>


                </div>
            </div>
            <div class="container">
                <div class="row" style='width:100%'>
                    <form method="post" action="" class='form-get-checkout-data' style='width:100%;'>
                        {% csrf_token  %}
                        <div class='col-12 pl-0 pr-3 text-left'>
                            <p class='mb-1' style='font-weight:bold;font-size:large;'>포인트</p>
                            <hr class='mt-0' style='border-top:2px solid #423f3b;height:5px;box-shadow: 0 10px 5px -10px #8c8c8c inset;'>
                        </div>
                        <div class='row' style='width:100%'>
                            <div class='col-8'>
                                <p style='font-size:medium;'>포인트 사용</p>
                            </div>
                            <div class='col-4 text-right'>
                                <input type="hidden" name='post_purpose' value='use_point'>
                                <input type="number" id="quantity" name="use_point" min=0 max="{{ point_available }}" style='width:100%;'>
                                
                            </div> 
                        </div>
                        <div class='row'>
                            <div class='col-12 text-right'>
                                <p style='font-size:small;'>* 최대 사용가능 Point : {{ point_available|floatformat:"0" }}</p>
                                <button type='submit' class='btn btn-dark btn-block'>포인트적용</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>




    <!-- 여기 폼에다가 수량 감소관련 정보를 POST할 수 있게 해줘야겠다.ㄴ -->


        <!-- 체크아웃정보 -->
    <div class='row'>
        <form action="" class='form-get-data' style='display:none;'>
            
            <input type="hidden" class='pg' name='pg' value='{{ pg }}'/>
            <input type="hidden" class='pay_method' name='pay_method' value='{{ pay_method }}'/>
            <input type="hidden" class='merchant_uid' name='merchant_uid' value='{{ merchant_uid }}'/>
            <input type="hidden" class='name'name='name' value='{{ name }}'/>
            <input type="hidden" class='amount' name='amount' value='{{ amount }}'/>
            <input type="hidden" class='buyer_email' value='{{ buyer_email }}'/>
            <input type="hidden" class='buyer_name' name='buyer_name' value='{{ buyer_name }}'/>
            <input type="hidden" class='buyer_tel' name='buyer_tel' value='{{ buyer_tel }}'/>
            <input type="hidden" class='buyer_addr' name='buyer_addr' value='{{ buyer_addr }}'/>
            <input type="hidden" class='buyer_postcode' name='buyer_postcode' value='{{ buyer_postcode }}'/>
        </form>
    </div>
</div>




















<!-- jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
<!-- iamport.payment.js -->
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>

<!-- 아임포트 CUSTOM js -->

<script type="text/javascript">
$(document).ready(function(){
    // Auto Search
    var getForm = $(".form-get-checkout-data")
    var getButton = getForm.find("#get-checkout-data-btn")
    getButton.click(function (event){
        var promise = $.ajax({
            url: "{% url 'carts:checkout-iamport' %}", //cross-domain error가 발생하지 않도록 동일한 도메인으로 전송
            type: 'POST',
            dataType: 'json',
            data: {get_data: "True",
                   post_purpose: "fianl_checkout"
                },
            
            success: function(data){
                // success start
                console.log("데이터를 성공적으로 받았쪄염.")

                console.log($(".pg").val())

                
                // 데이터 성공적으로 들어오기에 여기에 결재 function 넣는다.
                 
                //결재 펑션 여기가 끝이다.
                },
            
            // suceess end
            
            // error start
            //체크아웃데이터를 못받았을떼 웁스
            error: function(errordata){
                $.alert({
                    title: "Oops!",
                    content: "An error occurred",
                    theme: "modern"
                })
            }
        })
    })
    var checkoutDiv = $(".check-out-div")
    checkoutDiv.css('visibility', 'visible')
    var checkoutButton = $("#check-out-button")
    
    checkoutButton.click(function (event){
        console.log("클릭됐쪄염")
        requestPay()
    })
})

// 그냥 펑션 바깥에 꺼냈다. 나중에 실행만하자.
function requestPay() {
// IMP.request_pay(param, callback) 호출
    var IMP = window.IMP;
    var code = "imp30832141";  // FIXME: 가맹점 식별코드
    IMP.init(code);
    
    console.log("리퀘스트 페이 실행도ㅣ쪄염")
    // 결제요청
    IMP.request_pay({ // param
        pg : $(".pg").val(), // pg 사 선택
        pay_method : $(".pay_method").val(),
        merchant_uid : $(".merchant_uid").val(),// 'merchant_' + new Date().getTime(),
        name : $(".name").val(),
        amount : $(".amount").val(),
        buyer_email : $(".buyer_email").val(),
        buyer_name : $(".buyer_name").val(),
        buyer_tel : $(".buyer_tel").val(),
        buyer_addr : $(".buyer_addr").val(),
        buyer_postcode : $(".buyer_postcode").val(),
        m_redirect_url : "{% url 'carts:checkout-iamport' %}"
    }, function (rsp) {
        if (rsp.success) {
            //[1] 서버단에서 결제정보 조회를 위해 jQuery ajax로 imp_uid 전달하기
            jQuery.ajax({
                url: "{% url 'carts:checkout-iamport' %}", //cross-domain error가 발생하지 않도록 동일한 도메인으로 전송
                type: 'POST',
                dataType: 'json',
                data: {
                    imp_uid: rsp.imp_uid,
                    //기타 필요한 데이터가 있으면 추가 전달
                },
            }).done(function (data) {
                //[2] 서버에서 REST API로 결제정보확인 및 서비스루틴이 정상적인 경우
                alert("ajax done");               
                console.log("ajax done");
                if (data.status=='success') {
                    var msg = '결제가 완료되었습니다.';
                    msg += '\n고유ID : ' + rsp.imp_uid;
                    msg += '\n상점 거래ID : ' + rsp.merchant_uid;
                    msg += '\결제 금액 : ' + rsp.paid_amount;
                    msg += '카드 승인번호 : ' + rsp.apply_num;
                    alert(msg);
                    console.log(msg);
                    var checkOutText = $(".check-out-complete-text")
                    checkOutText.text("결재가 성공하였습니다.")
                    window.location.href= "{% url 'carts:success' %}"

                } else {
                    //[3] 아직 제대로 결제가 되지 않았습니다.
                    //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
                    var msg = '아직 제대로 결제가 되지 않았습니다.';
                    alert(msg);
                    console.log(msg);
                }
            }).fail(function () {
                alert("ajax fail");
                console.log("ajax fail");
            }).always(function () {
                alert("ajax always");
                console.log("ajax always");
            });
            
            // window.location.href= "{% url 'carts:payment_success' %}"


        } else {
            var msg = data.message;
            msg += '에러내용 : ' + rsp.error_msg;
            alert(msg);
            var checkOutText = $(".check-out-complete-text")
            checkOutText.text("결재가 실패하였습니다.")
            // 실패시 이동할 페이지
            // window.location.href= "{% url 'carts:payment_fail' %}"
        }
    });
}

</script>

{% endblock %} 